name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install Backend Dependencies
      run: |
        cd backend
        pip install -r requirements.txt

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install Frontend Dependencies
      run: |
        cd frontend
        npm install

    - name: Build Frontend
      run: |
        cd frontend
        npm run build

  deploy:
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Deploy to Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Install Docker & Docker Compose if not installed (First run only)
          if ! command -v docker &> /dev/null;
          then
             sudo apt-get update
             sudo apt-get install -y ca-certificates curl gnupg
             sudo install -m 0755 -d /etc/apt/keyrings
             curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
             sudo chmod a+r /etc/apt/keyrings/docker.gpg
             echo \
               "deb [arch=\"$(dpkg --print-architecture)\" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
               $(. /etc/os-release && echo \"$VERSION_CODENAME\") stable" | \
               sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
             sudo apt-get update
             sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
             # Add user to docker group
             sudo usermod -aG docker $USER
          fi

          # Prepare Project Directory
          mkdir -p ~/neutinamu_homepage
          cd ~/neutinamu_homepage

          # We can't use git pull effectively if we want to build locally on server without full repo history or managing git creds on server easily.
          # A simpler way for this scale is to scp the files or use git clone with a token if repo is private.
          # Assuming public or simple usage:
          
          # Check if git repo exists, if not clone (requires public repo or token in URL)
          # For this demo, let's assume we update code via git pull if it exists.
          if [ -d ".git" ]; then
            git pull origin main
          else
            # NOTE: If repo is private, you need to use a PAT token in the URL: https://<token>@github.com/...
            git clone https://github.com/aohus/neutinamu_homepage.git .
          fi

          # Build and Run with Docker Compose directly on server
          # This builds images locally on the server, avoiding Docker Hub.
          sudo docker compose down
          sudo docker compose up -d --build --remove-orphans
          
          # Prune unused images to save space
          sudo docker image prune -f